<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <th:block layout:fragment="head">
        <title>Editar Movimiento en Kardex</title>
    </th:block>
</head>

<body>
<div layout:fragment="content" class="container mt-5">
    <h2 class="mb-4"><i class="bi bi-pencil-square"></i> Editar Movimiento en Kardex</h2>

    <form th:action="@{/kardex/update}" method="post" th:object="${kardex}">
        <input type="hidden" th:field="*{idKardex}" />
        <input type="hidden" th:field="*{idEstado}" />

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark">
                <strong><i class="bi bi-archive"></i> Datos del Movimiento</strong>
            </div>
            <div class="card-body">
                <div class="row g-3">

                    <div class="col-md-6">
                        <label for="producto" class="form-label">Producto</label>
                        <select id="producto" name="producto.id" class="form-select">
                            <option th:each="p : ${productos}"
                                    th:value="${p.id}"
                                    th:text="${p.nombreProducto}"
                                    th:selected="${kardex.producto != null} ? ${p.id} == ${kardex.producto.id} : false">
                            </option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="tipoMovimiento" class="form-label">Tipo de Movimiento</label>
                        <select id="tipoMovimiento" name="tipoMovimiento.id" class="form-select">
                            <option th:each="t : ${tiposMovimiento}"
                                    th:value="${t.id}"
                                    th:text="${t.nombre}"
                                    th:selected="${kardex.tipoMovimiento != null} ? ${t.id} == ${kardex.tipoMovimiento.id} : false">
                            </option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="cantidad" class="form-label">Cantidad</label>
                        <input type="number" step="0.001" th:field="*{cantidad}" class="form-control" />
                    </div>

                    <div class="col-md-4">
                        <label for="stockResultante" class="form-label">Stock Resultante</label>
                        <input type="number" step="0.001" th:field="*{stockResultante}" class="form-control" />
                    </div>

                    <div class="col-md-4">
                        <label for="precioUnitario" class="form-label">Precio Unitario</label>
                        <input type="number" step="0.01" th:field="*{precioUnitario}" class="form-control" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Tipo Documento Ref.</label>
                        <select id="tipoDocRef" name="documentoReferencia.tipo" class="form-select" required>
                            <option value="" disabled selected>Seleccione...</option>
                            <option value="VENTA">VENTA</option>
                            <option value="PEDIDO">PEDIDO</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Documento Referencia</label>
                        <select id="idDocRef" name="documentoReferencia.id" class="form-select" required>
                            <option value="" disabled selected>Seleccione tipo primero...</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">NÃºmero Documento Ref.</label>
                        <input type="text" id="numeroDocRef" name="documentoReferencia.numero" class="form-control" readonly>
                    </div>
                    

                    
                    <div class="col-md-6">
                        <label for="sucursal" class="form-label">Sucursal</label>
                        <select id="sucursal" name="sucursal.idSucursal" class="form-select">
                            <option th:each="s : ${sucursales}"
                                    th:value="${s.idSucursal}"
                                    th:text="${s.nombreSucursal}"
                                    th:selected="${kardex.sucursal != null} ? ${s.idSucursal} == ${kardex.sucursal.idSucursal} : false">
                            </option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="fechaMovimiento" class="form-label">Fecha del Movimiento</label>
                        <input type="datetime-local" name="fechaMovimiento" id="fechaMovimiento"
                               th:value="${#temporals.format(kardex.fechaMovimiento, 'yyyy-MM-dd\'T\'HH:mm')}"
                               class="form-control" />
                    </div>

                    <div class="col-md-12">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea th:field="*{observaciones}" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div class="text-end">
            <button type="submit" class="btn btn-warning">
                <i class="bi bi-save"></i> Actualizar
            </button>
            <a th:href="@{/kardex}" class="btn btn-secondary">
                <i class="bi bi-arrow-left-circle"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<th:block layout:fragment="js"></th:block>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tipoSelect = document.getElementById("tipoDocRef");
        const idDocSelect = document.getElementById("idDocRef");
        const numeroDocInput = document.getElementById("numeroDocRef");

        tipoSelect.addEventListener("change", function () {
            const tipo = this.value;
            idDocSelect.innerHTML = '<option disabled selected>Cargando...</option>';
            numeroDocInput.value = "";

            fetch(`/api/documentos/${tipo.toLowerCase()}s`)
                .then(res => res.json())
                .then(data => {
                    idDocSelect.innerHTML = '<option disabled selected>Seleccione...</option>';
                    data.forEach(doc => {
                        const option = document.createElement("option");
                        option.value = doc.id;
                        option.text = `${doc.numero} - ${doc.cliente}`;
                        option.dataset.numero = doc.numero;
                        idDocSelect.appendChild(option);
                    });
                })
                .catch(() => {
                    idDocSelect.innerHTML = '<option disabled selected>Error al cargar</option>';
                });
        });

        idDocSelect.addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            numeroDocInput.value = selectedOption.dataset.numero || "";
        });
    });

</script>
</body>
</html>
